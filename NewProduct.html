<!doctype html>
<html>

<head>
  <title>Yeni Bisiklet Ürünü Ekle</title>
  <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <link href="css/frame.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="css/controls.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="css/custom.css" media="screen" rel="stylesheet" type="text/css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <style>
    .menu { background-color: #7098e2; }
    
    /* Input Grupları İçin Temel Ayarlar */
    .input-group { 
        display: flex; 
        align-items: center; 
        gap: 10px; 
        margin-bottom: 15px; 
    }
    .input-group label { width: 100px; }
    .input-group select, .input-group input[type="text"], .input-group input[type="number"] {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        max-width: 180px;
    }
    .input-group input[type="text"].new-input {
        max-width: 150px;
    }
    .input-group button { min-width: 60px; }
    
    /* Mobil Menü Stilleri */
    @media (max-width: 850px) {
        /* Form elemanlarını alt alta diz */
        #productForm, .input-group {
            display: block; 
        }
        .input-group {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            width: auto;
        }
        .input-group select, .input-group input:not(.new-input) {
            width: 100%;
            max-width: none;
        }
        .input-group input.new-input {
            width: calc(100% - 70px); /* Buton için yer bırak */
        }
        .input-group button {
            margin-left: 5px;
        }

        /* Menü Düzeltmesi */
        .menu-items { 
            display: none; 
            flex-direction: column; 
            width: 100%;
            position: absolute;
            top: 50px; 
            left: 0;
            background-color: #7098e2;
            z-index: 50; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            padding-bottom: 10px;
        }
        .menu-items.active {
            display: flex; 
        }
        .menu-items a, .menu-items button {
            width: 100%;
            text-align: center;
            padding: 10px 0;
            border-bottom: 1px solid #5a7ca8;
        }
    }
  </style>
</head>

<body>
  
  <div class="menu">
    <div class="menu-table flex-row-space-between">
      <div class="logo flex-row-center"><a href="index.html">MSES</a></div>
      
      <a class="menu-button" tabindex="0" href="javascript:void(0)">
        <img src="img/menu.png">
      </a>
      
      <div class="menu-items flex-row-center flex-item">
        <a href="index.html" class="menu-index">Ana Panel</a>
        <a href="ProductUpdate.html" class="menu-calender">Stok Takip</a>
        <a href="NewProduct.html" class="menu-aboutus" style="font-weight: 700;">+ Yeni Ürün</a>
        <button id="signOutButton" class="menu-help">Sign Out</button>
      </div>
    </div>
  </div>

  <h1>Yeni Bisiklet Ürünü Ekle</h1>
  <p id="uploadStatus" style="color: blue; font-weight: bold;"></p>

  <form id="productForm">
    
    <div class="input-group">
        <label for="brandSelect">Marka:</label>
        <select id="brandSelect" required></select>
        <input type="text" id="brandInput" class="new-input" placeholder="Yeni Marka Adı" style="display:none;">
        <button type="button" id="addNewBrandBtn" style="display:none;">Ekle</button>
    </div>

    <div class="input-group">
        <label for="modelSelect">Model Adı:</label>
        <select id="modelSelect" required></select>
        <input type="text" id="modelInput" class="new-input" placeholder="Yeni Model Adı" style="display:none;">
        <button type="button" id="addNewModelBtn" style="display:none;">Ekle</button>
    </div>
    
    <div class="input-group">
        <label for="wheel_size">Jant Boyutu:</label>
        <select id="wheel_size" required>
            <option value="">Seçin...</option>
            <option value="12">12</option>
            <option value=" "> </option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="20">20</option>
            <option value="24">24</option>
            <option value="26">26</option>
            <option value="27.5">27.5</option>
            <option value="28">28</option>
            <option value="29">29</option>
        </select>
    </div>

    <div class="input-group">
        <label for="colorSelect">Renk:</label>
        <select id="colorSelect" required></select>
        <input type="text" id="colorInput" class="new-input" placeholder="Yeni Renk Adı" style="display:none;">
        <button type="button" id="addNewColorBtn" style="display:none;">Ekle</button>
    </div>
    
    <div class="input-group">
        <label for="buy_price">Alış Fiyatı (₺):</label>
        <input type="number" id="buy_price" step="0.01" min="0" required value="0" style="max-width: 300px;">
    </div>
    <div class="input-group">
        <label for="sell_price">Satış Fiyatı (₺):</label>
        <input type="number" id="sell_price" step="0.01" min="0" required value="0" style="max-width: 300px;">
    </div>
    <div class="input-group">
        <label for="stock_quantity">Stok Adedi:</label>
        <input type="number" id="stock_quantity" min="0" required value="1" style="max-width: 300px;">
    </div>

    <label for="imageInput">Ürün Görseli: **(Dosya Seç/Fotoğraf Çek)**</label>
    <input type="file" id="imageInput" accept="image/*" capture="camera"><br><br> 
    
    <button type="submit" style="padding: 10px 20px; background-color: green; color: white; border: none; border-radius: 4px; cursor: pointer;">Ürünü Kaydet</button>
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref as dbRef, set, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // Firebase yapılandırması (Aynı kalır)
    const firebaseConfig = {
      apiKey: "AIzaSyBSCuSjLtRxCicBpiYE4zV_CQ6iF23CMos",
      authDomain: "ceit133-mses.firebaseapp.com",
      databaseURL: "https://ceit133-mses-default-rtdb.firebaseio.com",
      projectId: "ceit133-mses",
      storageBucket: "ceit133-mses.appspot.com",
      messagingSenderId: "803859950218",
      appId: "1:803859950218:web:48b897035bb041d1799b73",
      measurementId: "G-09BSCKLQ2Y"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const auth = getAuth(app);
    const database = getDatabase(app);

    const productForm = document.getElementById('productForm');
    const imageInput = document.getElementById('imageInput');
    const uploadStatus = document.getElementById('uploadStatus');
    const signOutButton = document.getElementById('signOutButton');

    // Select Elementleri
    const brandSelect = document.getElementById('brandSelect');
    const modelSelect = document.getElementById('modelSelect');
    const colorSelect = document.getElementById('colorSelect');
    
    // Input Elementleri
    const brandInput = document.getElementById('brandInput');
    const modelInput = document.getElementById('modelInput');
    const colorInput = document.getElementById('colorInput');

    // Buton Elementleri
    const addNewBrandBtn = document.getElementById('addNewBrandBtn');
    const addNewModelBtn = document.getElementById('addNewModelBtn');
    const addNewColorBtn = document.getElementById('addNewColorBtn');

    // Mobil Menü Elementleri
    const menuButton = document.querySelector('.menu-button');
    const menuItems = document.querySelector('.menu-items');
    
    // Mobil Menü Aç/Kapa
    menuButton.addEventListener('click', () => {
        menuItems.classList.toggle('active');
    });

    let currentUser = null;
    let modelsByBrand = {}; 
    let uniqueColors = new Set(); 

    // Giriş Kontrolü
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            populateSelectors(); 
            setupEventListeners();
        } else {
            alert('Bu sayfayı kullanmak için giriş yapmalısınız.');
            window.location.href = './login.html';
        }
    });

    signOutButton.addEventListener('click', () => {
        signOut(auth).then(() => {
            alert('Oturum başarıyla kapatıldı!');
            window.location.href = './index.html';
        });
    });

    // =======================================================
    // DİNAMİK SEÇİCİLERİ DOLDURMA İŞLEVİ
    // =======================================================
    function populateSelectors() {
        const productsRef = dbRef(database, `products`);
        
        onValue(productsRef, (snapshot) => {
            const uniqueBrands = new Set();
            uniqueColors = new Set(); 
            modelsByBrand = {};
            
            snapshot.forEach((childSnapshot) => {
                const product = childSnapshot.val();
                
                if (product.brand) {
                    uniqueBrands.add(product.brand);
                    if (!modelsByBrand[product.brand]) modelsByBrand[product.brand] = new Set();
                    if (product.model) modelsByBrand[product.brand].add(product.model);
                }
                if (product.color) uniqueColors.add(product.color);
            });

            fillSelect(brandSelect, uniqueBrands, 'Marka Seçiniz');
            fillSelect(colorSelect, uniqueColors, 'Renk Seçiniz');
            
            if (brandSelect.value && brandSelect.value !== 'YENI_EKLE') {
                updateModelSelect(brandSelect.value);
            }

        }, {
            onlyOnce: false
        });
    }

    function fillSelect(selectElement, itemsSet, defaultText) {
        const currentVal = selectElement.value;
        selectElement.innerHTML = '';
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = defaultText;
        selectElement.appendChild(defaultOption);

        const newOption = document.createElement('option');
        newOption.value = 'YENI_EKLE';
        newOption.textContent = '--- Yeni Ekle ---';
        selectElement.appendChild(newOption);
        
        itemsSet.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.textContent = item;
            selectElement.appendChild(option);
        });

        selectElement.value = currentVal; 
    }

    function updateModelSelect(selectedBrand) {
        if (modelsByBrand[selectedBrand]) {
            fillSelect(modelSelect, modelsByBrand[selectedBrand], 'Model Seçiniz');
        } else {
            fillSelect(modelSelect, new Set(), 'Model Seçiniz');
        }
    }


    // =======================================================
    // DİNAMİK OLAY DİNLEYİCİLERİ VE BUTON MANTIKLARI
    // =======================================================
    function setupEventListeners() {
        brandSelect.addEventListener('change', () => {
            const selectedBrand = brandSelect.value;
            toggleNewInputAndButton(selectedBrand, brandInput, addNewBrandBtn);
            
            modelSelect.disabled = !selectedBrand || selectedBrand === 'YENI_EKLE';
            modelSelect.value = '';
            modelInput.style.display = 'none';
            addNewModelBtn.style.display = 'none';
            modelInput.value = '';

            if (selectedBrand && selectedBrand !== 'YENI_EKLE') {
                updateModelSelect(selectedBrand);
            } else {
                modelSelect.innerHTML = '<option value="">Önce Marka Seçiniz</option>';
            }
        });

        modelSelect.addEventListener('change', () => {
            toggleNewInputAndButton(modelSelect.value, modelInput, addNewModelBtn);
        });

        colorSelect.addEventListener('change', () => {
            toggleNewInputAndButton(colorSelect.value, colorInput, addNewColorBtn);
        });
        
        // Yeni Değer EKLEME Butonu Mantığı
        addNewBrandBtn.addEventListener('click', () => { addValueToSelect(brandSelect, brandInput); });
        addNewModelBtn.addEventListener('click', () => { 
             addValueToSelect(modelSelect, modelInput); 
             const currentBrand = brandSelect.value;
             if (modelsByBrand[currentBrand]) {
                 modelsByBrand[currentBrand].add(modelInput.value.trim());
             }
        });
        addNewColorBtn.addEventListener('click', () => { addValueToSelect(colorSelect, colorInput); });
    }

    function toggleNewInputAndButton(selectedValue, inputElement, buttonElement) {
        if (selectedValue === 'YENI_EKLE') {
            inputElement.style.display = 'block';
            buttonElement.style.display = 'block';
            inputElement.required = true;
            inputElement.focus();
        } else {
            inputElement.style.display = 'none';
            buttonElement.style.display = 'none';
            inputElement.required = false;
        }
    }
    
    function addValueToSelect(selectElement, inputElement) {
        const newValue = inputElement.value.trim();
        if (!newValue) {
            alert('Lütfen bir değer girin.');
            return;
        }
        
        let exists = Array.from(selectElement.options).some(opt => opt.value === newValue);
        
        if (!exists) {
            const newOption = document.createElement('option');
            newOption.value = newValue;
            newOption.textContent = newValue;
            selectElement.appendChild(newOption);
        }
        
        selectElement.value = newValue;
        
        inputElement.style.display = 'none';
        inputElement.required = false;
        buttonElement.style.display = 'none';
        inputElement.value = ''; 
    }


    // =======================================================
    // ÜRÜN KAYDETME İŞLEVİ
    // =======================================================
    productForm.addEventListener('submit', (e) => {
        e.preventDefault();

        const brandValue = brandSelect.value.trim();
        const modelValue = modelSelect.value.trim();
        const colorValue = colorSelect.value.trim();
        
        const wheelSizeValue = document.getElementById('wheel_size').value.trim();
        const buyPriceValue = parseFloat(document.getElementById('buy_price').value);
        const sellPriceValue = parseFloat(document.getElementById('sell_price').value);
        const quantityValue = parseInt(document.getElementById('stock_quantity').value);
        const file = imageInput.files[0];

        // Zorunlu alan kontrolü (Resim hariç)
        if (!brandValue || !modelValue || !wheelSizeValue || !colorValue) { 
            uploadStatus.textContent = 'Lütfen tüm zorunlu (resim hariç) alanları doldurun.'; 
            return; 
        }
        
        const skuValue = (modelValue + wheelSizeValue).replace(/\s/g, ''); 
        
        // Resim Yükleme Mantığı (Koşullu)
        if (file) {
            uploadStatus.textContent = 'Ürün görseli yükleniyor...';

            const filePath = `products_images/${currentUser.uid}/${skuValue}_${colorValue}_${file.name}`;
            const storageRef_ = storageRef(storage, filePath);

            uploadBytes(storageRef_, file)
                .then((snapshot) => getDownloadURL(snapshot.ref))
                .then((url) => {
                    saveProductToDatabase({
                        uid: currentUser.uid, url, filePath, brand: brandValue, model: modelValue, wheel_size: wheelSizeValue, color: colorValue, sku: skuValue, buy_price: buyPriceValue, sell_price: sellPriceValue, stock_quantity: quantityValue
                    });
                    uploadStatus.textContent = `Yeni Ürün (${skuValue}) başarıyla kaydedildi!`;
                    productForm.reset();
                })
                .catch((error) => { 
                    uploadStatus.textContent = `Resim yüklenirken veya kaydedilirken hata oluştu: ${error.message}`; 
                });
        } else {
            // Resim YOK ise, doğrudan boş URL ile veritabanına kaydet
            uploadStatus.textContent = 'Ürün görseli olmadan kaydediliyor...';
            saveProductToDatabase({
                uid: currentUser.uid, url: '', filePath: '', brand: brandValue, model: modelValue, wheel_size: wheelSizeValue, color: colorValue, sku: skuValue, buy_price: buyPriceValue, sell_price: sellPriceValue, stock_quantity: quantityValue
            });
            uploadStatus.textContent = `Yeni Ürün (${skuValue}) başarıyla kaydedildi (Resimsiz)!`;
            productForm.reset();
        }
    });

    function saveProductToDatabase(productData) {
        const productsRef = dbRef(database, `products`);
        const newProductRef = push(productsRef);

        set(newProductRef, {
            name: `${productData.brand} ${productData.model} ${productData.wheel_size} Jant ${productData.color}`,
            brand: productData.brand,
            model: productData.model,
            wheel_size: productData.wheel_size,
            color: productData.color,
            sku: productData.sku,
            buy_price: productData.buy_price,
            sell_price: productData.sell_price,
            stock_quantity: productData.stock_quantity,
            image_url: productData.url,
            storage_path: productData.filePath,
            user_uid: productData.uid,
            created_at: Date.now()
        });
    }
  </script>
</body>
</html>        
